<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè¢ EV Central - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin-bottom: 30px;
        }

        .connection-status {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #1e3c72;
        }

        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .data-table h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table thead {
            background: #f8f9fa;
        }

        table th {
            padding: 15px;
            text-align: left;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-charging {
            background: #fff3cd;
            color: #856404;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .status-active {
            background: #cce5ff;
            color: #004085;
        }

        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 968px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-dot.green {
            background: #28a745;
        }

        .status-dot.red {
            background: #dc3545;
        }

        .status-dot.yellow {
            background: #ffc107;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .event-stream {
            background: #1e1e1e;
            color: #00ff00;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .event-stream .event-line {
            margin-bottom: 8px;
        }

        .event-stream .timestamp {
            color: #888;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
        }

        .refresh-indicator.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="refresh-indicator" id="refreshIndicator">
        <span class="status-dot green"></span> Actualizando...
    </div>

    <div class="container">
        <h1>üè¢ EV Central - Admin Dashboard</h1>
        <p class="subtitle">Panel de Control del Sistema de Carga</p>

        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status disconnected">
            <span class="status-dot red"></span>
            <span>Desconectado del servidor</span>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">üë•</div>
                <div class="label">Usuarios Registrados</div>
                <div class="value" id="totalUsers">0</div>
            </div>
            <div class="stat-card">
                <div class="icon">üîå</div>
                <div class="label">Puntos de Carga</div>
                <div class="value" id="totalCPs">0</div>
            </div>
            <div class="stat-card">
                <div class="icon">‚ö°</div>
                <div class="label">Sesiones Activas</div>
                <div class="value" id="activeSessions">0</div>
            </div>
            <div class="stat-card">
                <div class="icon">üí∞</div>
                <div class="label">Ingresos Hoy</div>
                <div class="value" id="todayRevenue">‚Ç¨0</div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid-2col">
            <!-- Active Sessions Table -->
            <div class="data-table">
                <h2>‚ö° Sesiones Activas</h2>
                <table id="sessionsTable">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Punto de Carga</th>
                            <th>Energ√≠a (kWh)</th>
                            <th>Costo</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsBody">
                        <tr>
                            <td colspan="5" class="empty-state">No hay sesiones activas</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Charging Points Status -->
            <div class="data-table">
                <h2>üîå Estado de Puntos de Carga</h2>
                <table id="cpTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ubicaci√≥n</th>
                            <th>Potencia</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="cpBody">
                        <tr>
                            <td colspan="4" class="empty-state">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Users -->
        <div class="data-table">
            <h2>üë• Usuarios Conectados Recientemente</h2>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Email</th>
                        <th>Balance</th>
                        <th>Rol</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    <tr>
                        <td colspan="5" class="empty-state">No hay datos de usuarios</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Event Stream -->
        <div class="data-table">
            <h2>üì° Stream de Eventos en Tiempo Real</h2>
            <div class="event-stream" id="eventStream">
                <div class="event-line">Sistema iniciado. Esperando eventos...</div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let dashboardData = {
            users: [],
            charging_points: [],
            active_sessions: [],
            stats: {
                total_users: 0,
                total_cps: 0,
                active_sessions: 0,
                today_revenue: 0
            }
        };

        function connectWebSocket() {
            const wsUrl = 'ws://localhost:8002/ws';
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
                // Request initial data
                ws.send(JSON.stringify({ type: 'get_dashboard_data' }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            const dot = statusDiv.querySelector('.status-dot');
            const text = statusDiv.querySelector('span:last-child');

            if (connected) {
                statusDiv.className = 'connection-status connected';
                dot.className = 'status-dot green';
                text.textContent = 'Conectado al servidor central';
            } else {
                statusDiv.className = 'connection-status disconnected';
                dot.className = 'status-dot red';
                text.textContent = 'Desconectado del servidor';
            }
        }

        function handleServerMessage(data) {
            console.log('Received:', data);

            switch(data.type) {
                case 'dashboard_data':
                    dashboardData = data.data;
                    updateDashboard();
                    break;

                case 'session_update':
                    addEventLog(`üìä Actualizaci√≥n de sesi√≥n: ${data.username} - ${data.energy.toFixed(2)} kWh`);
                    showRefreshIndicator();
                    break;

                case 'session_started':
                    addEventLog(`‚úÖ Nueva sesi√≥n iniciada: ${data.username} en ${data.cp_id}`);
                    showRefreshIndicator();
                    break;

                case 'session_ended':
                    addEventLog(`‚õî Sesi√≥n finalizada: ${data.username} - Total: ‚Ç¨${data.cost.toFixed(2)}`);
                    showRefreshIndicator();
                    break;

                case 'cp_status_change':
                    addEventLog(`üîå Estado CP ${data.cp_id}: ${data.status}`);
                    showRefreshIndicator();
                    break;

                case 'user_login':
                    addEventLog(`üë§ Usuario conectado: ${data.username}`);
                    break;

                case 'system_event':
                    addEventLog(`‚öôÔ∏è ${data.message}`);
                    break;
            }
        }

        function updateDashboard() {
            // Update statistics
            document.getElementById('totalUsers').textContent = dashboardData.stats.total_users;
            document.getElementById('totalCPs').textContent = dashboardData.stats.total_cps;
            document.getElementById('activeSessions').textContent = dashboardData.stats.active_sessions;
            document.getElementById('todayRevenue').textContent = `‚Ç¨${dashboardData.stats.today_revenue.toFixed(2)}`;

            // Update charging points table
            updateCPTable();

            // Update active sessions table
            updateSessionsTable();

            // Update users table
            updateUsersTable();
        }

        function updateCPTable() {
            const tbody = document.getElementById('cpBody');
            tbody.innerHTML = '';

            if (dashboardData.charging_points.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No hay puntos de carga registrados</td></tr>';
                return;
            }

            dashboardData.charging_points.forEach(cp => {
                const row = document.createElement('tr');
                
                let statusClass = 'status-available';
                let statusText = 'Disponible';
                let dotColor = 'green';

                if (cp.status === 'charging') {
                    statusClass = 'status-charging';
                    statusText = 'Cargando';
                    dotColor = 'yellow';
                } else if (cp.status === 'offline') {
                    statusClass = 'status-offline';
                    statusText = 'Fuera de l√≠nea';
                    dotColor = 'red';
                }

                row.innerHTML = `
                    <td><strong>${cp.cp_id}</strong></td>
                    <td>${cp.location}</td>
                    <td>${cp.power_output} kW</td>
                    <td><span class="status-badge ${statusClass}">
                        <span class="status-dot ${dotColor}"></span>${statusText}
                    </span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSessionsTable() {
            const tbody = document.getElementById('sessionsBody');
            tbody.innerHTML = '';

            if (dashboardData.active_sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No hay sesiones activas</td></tr>';
                return;
            }

            dashboardData.active_sessions.forEach(session => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${session.username}</strong></td>
                    <td>${session.cp_id}</td>
                    <td>${session.energy.toFixed(2)} kWh</td>
                    <td>‚Ç¨${session.cost.toFixed(2)}</td>
                    <td><span class="status-badge status-active">
                        <span class="status-dot green"></span>Activa
                    </span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateUsersTable() {
            const tbody = document.getElementById('usersBody');
            tbody.innerHTML = '';

            if (dashboardData.users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No hay datos de usuarios</td></tr>';
                return;
            }

            dashboardData.users.slice(0, 10).forEach(user => {
                const row = document.createElement('tr');
                const statusClass = user.is_active ? 'status-active' : 'status-available';
                const statusText = user.is_active ? 'Activo' : 'Inactivo';

                row.innerHTML = `
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email}</td>
                    <td>‚Ç¨${user.balance.toFixed(2)}</td>
                    <td>${user.role}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function addEventLog(message) {
            const streamDiv = document.getElementById('eventStream');
            const now = new Date().toLocaleTimeString();
            const eventLine = document.createElement('div');
            eventLine.className = 'event-line';
            eventLine.innerHTML = `<span class="timestamp">[${now}]</span> ${message}`;
            streamDiv.insertBefore(eventLine, streamDiv.firstChild);

            // Keep only last 50 events
            while (streamDiv.children.length > 50) {
                streamDiv.removeChild(streamDiv.lastChild);
            }
        }

        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.add('active');
            setTimeout(() => {
                indicator.classList.remove('active');
            }, 2000);

            // Request updated data
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'get_dashboard_data' }));
            }
        }

        // Auto-refresh every 5 seconds
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'get_dashboard_data' }));
            }
        }, 5000);

        // Initialize
        connectWebSocket();
    </script>
</body>
</html>
