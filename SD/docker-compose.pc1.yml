# ============================================================================
# Docker Compose para PC1 - Driver Interface
# ============================================================================
# EJECUTAR SOLO EN PC1 (Driver)
#
# Este PC ejecuta:
#   - EV_Driver WebSocket Dashboard (puerto 8001)
#
# REQUISITOS PREVIOS:
#   1. PC2 debe estar ejecutando Kafka y EV_Central
#   2. Editar network_config.py con las IPs reales
#   3. Copiar ev_charging.db desde PC2
#   4. Abrir puerto del firewall:
#      New-NetFirewallRule -DisplayName "EV Driver WS" -Direction Inbound -LocalPort 8001 -Protocol TCP -Action Allow
#
# INICIAR:
#   docker-compose -f docker-compose.pc1.yml up -d
#
# VER LOGS:
#   docker-compose -f docker-compose.pc1.yml logs -f
#
# DETENER:
#   docker-compose -f docker-compose.pc1.yml down
# ============================================================================

services:
  # ==========================================================================
  # EV Driver (WebSocket + Kafka)
  # ==========================================================================
  ev-driver:
    build:
      context: .
      dockerfile: EV_Driver/Dockerfile
    container_name: ev-driver
    # network_mode: "host"  # No funciona en Windows - usar mapeo de puertos normal
    ports:
      - "8001:8001"
    environment:
      # Kafka broker está en PC2
      - KAFKA_BROKER=192.168.71.1:9092
      - CENTRAL_IP=192.168.71.1
      - WS_PORT=8001
      - PYTHONUNBUFFERED=1
    volumes:
      - ./ev_charging.db:/app/ev_charging.db
      - ./network_config.py:/app/network_config.py
      - ./database.py:/app/database.py
      - ./event_utils.py:/app/event_utils.py
      - ./EV_Driver/dashboard.html:/app/dashboard.html
    networks:
      - ev-network
    restart: unless-stopped

# ==============================================================================
# NOTA: Se usa network_mode: "host" para que el contenedor pueda acceder
# directamente a los servicios en PC2 (Kafka y EV_Central)
# ==============================================================================

networks:
  ev-network:
    external: true
    name: ev-network

# ==============================================================================
# VERIFICACIÓN DE CONECTIVIDAD
# ==============================================================================
# Antes de iniciar, verificar conexión con PC2:
#   ping PLACEHOLDER_PC2_IP
#   Test-NetConnection PLACEHOLDER_PC2_IP -Port 9092  # Kafka
#   Test-NetConnection PLACEHOLDER_PC2_IP -Port 5000  # EV_Central
# ==============================================================================

# ==============================================================================
# ACCESO AL DASHBOARD
# ==============================================================================
# Driver Dashboard:    http://PLACEHOLDER_PC1_IP:8001
# ==============================================================================
