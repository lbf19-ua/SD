# ============================================================================
# Docker Compose para PC1 - Driver Interface
# ============================================================================
# EJECUTAR SOLO EN PC1 (Driver)
#
# Este PC ejecuta:
#   - EV_Driver WebSocket Dashboard (puerto 8001)
#
# REQUISITOS PREVIOS:
#   1. PC2 debe estar ejecutando Kafka y EV_Central
#   2. Editar network_config.py con las IPs reales
#   3. Copiar ev_charging.db desde PC2
#   4. Abrir puerto del firewall (PowerShell como admin):
#      New-NetFirewallRule -DisplayName "EV Driver" -Direction Inbound -LocalPort 8001 -Protocol TCP -Action Allow
#
# INICIAR:
#   docker-compose -f docker-compose.pc1.yml up -d
#
# VER LOGS:
#   docker-compose -f docker-compose.pc1.yml logs -f
#
# DETENER:
#   docker-compose -f docker-compose.pc1.yml down
# ============================================================================

services:
  # ==========================================================================
  # EV Driver (WebSocket + Kafka)
  # ==========================================================================
  ev-driver:
    build:
      context: .
      dockerfile: EV_Driver/Dockerfile
    container_name: ev-driver
    ports:
      - "8001:8001"
    environment:
      # ⚠️ Para localhost: usar nombre del servicio Kafka (broker:29092)
      # ⚠️ Para red local: usar IP real de PC2 (ej: 192.168.1.235:9092)
      - KAFKA_BROKER=broker:29092  # Para localhost (misma red Docker)
      - CENTRAL_IP=localhost
      - DRIVER_PORT=8001
      - PYTHONUNBUFFERED=1
    volumes:
      - ./ev_charging.db:/app/ev_charging.db
      - ./network_config.py:/app/network_config.py
      - ./database.py:/app/database.py
      - ./event_utils.py:/app/event_utils.py
      - ./EV_Driver/dashboard.html:/app/dashboard.html
      - ./EV_Driver/servicios.txt:/app/servicios.txt
    networks:
      - ev-network
    restart: unless-stopped

# ==============================================================================
# Redes
# ==============================================================================
networks:
  ev-network:
    external: true
    name: ev-network

# ==============================================================================
# VERIFICACIÓN DE CONECTIVIDAD
# ==============================================================================
# Antes de iniciar, verificar conexión con PC2:
#   ping 192.168.1.235
#   Test-NetConnection 192.168.1.235 -Port 9092  # Kafka
#   Test-NetConnection 192.168.1.235 -Port 9999  # EV_Central
# ==============================================================================

# ==============================================================================
# ACCESO AL DASHBOARD
# ==============================================================================
# Driver Dashboard:    http://192.168.1.100:8001 (cambiar por IP real de PC1)
# ==============================================================================
