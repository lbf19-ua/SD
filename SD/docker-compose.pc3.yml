# ============================================================================
# Docker Compose para PC3 - Monitor Dashboard
# ============================================================================
# EJECUTAR SOLO EN PC3 (Monitor)
#
# Este PC ejecuta:
#   - EV_CP_M WebSocket Dashboard (puerto 8003)
#
# REQUISITOS PREVIOS:
#   1. PC2 debe estar ejecutando Kafka y EV_Central
#   2. Editar network_config.py con las IPs reales
#   3. Copiar ev_charging.db desde PC2
#   4. Abrir puerto del firewall:
#      New-NetFirewallRule -DisplayName "EV Monitor WS" -Direction Inbound -LocalPort 8003 -Protocol TCP -Action Allow
#
# INICIAR:
#   docker-compose -f docker-compose.pc3.yml up -d
#
# VER LOGS:
#   docker-compose -f docker-compose.pc3.yml logs -f
#
# DETENER:
#   docker-compose -f docker-compose.pc3.yml down
# ============================================================================

services:
  # ==========================================================================
  # EV Monitor (WebSocket + Kafka)
  # ==========================================================================
  ev-monitor:
    build:
      context: .
      dockerfile: EV_CP_M/Dockerfile
    container_name: ev-monitor
    network_mode: "host"  # Usar red del host para conectar a PC2
    environment:
      # Kafka broker está en PC2
      # Central server está en PC2
      - WS_PORT=8003
      - PYTHONUNBUFFERED=1
    volumes:
      - ./ev_charging.db:/app/ev_charging.db:ro
      - ./network_config.py:/app/network_config.py:ro
      - ./database.py:/app/database.py:ro
      - ./event_utils.py:/app/event_utils.py:ro
      - ./EV_CP_M/monitor_dashboard.html:/app/monitor_dashboard.html:ro
    restart: unless-stopped

# ==============================================================================
# NOTA: Se usa network_mode: "host" para que el contenedor pueda acceder
# directamente a los servicios en PC2 (Kafka y EV_Central)
# ==============================================================================

# ==============================================================================
# VERIFICACIÓN DE CONECTIVIDAD
# ==============================================================================
# Antes de iniciar, verificar conexión con PC2:
#   ping PLACEHOLDER_PC2_IP
#   Test-NetConnection PLACEHOLDER_PC2_IP -Port 9092  # Kafka
#   Test-NetConnection PLACEHOLDER_PC2_IP -Port 5000  # EV_Central
# ==============================================================================

# ==============================================================================
# ACCESO AL DASHBOARD
# ==============================================================================
# Monitor Dashboard:   http://PLACEHOLDER_PC3_IP:8003
# ==============================================================================
