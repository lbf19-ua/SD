<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Driver Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-card h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .status-card .value {
            font-size: 3em;
            font-weight: bold;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .info-box label {
            display: block;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-box .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.green {
            background: #28a745;
        }

        .status-dot.red {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
        }

        .login-form input {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .hidden {
            display: none;
        }

        .event-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .event-log h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .event-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 5px;
            font-size: 0.9em;
            border-left: 3px solid #667eea;
        }

        .event-item .timestamp {
            color: #999;
            font-size: 0.85em;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
    <h1>EV Driver Dashboard</h1>
        <p class="subtitle">Sistema de Carga de Veh√≠culos El√©ctricos</p>

        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status disconnected">
            <span class="status-dot red"></span>
            <span>Desconectado del servidor</span>
        </div>

        <!-- Login Form -->
        <div id="loginSection">
            <form class="login-form" onsubmit="login(event)">
                <input type="text" id="username" placeholder="Usuario (ej: driver1)" required>
                <input type="password" id="password" placeholder="Contrase√±a (ej: pass123)" required>
                <button type="submit" class="btn btn-primary">Iniciar Sesi√≥n</button>
            </form>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardSection" class="hidden">
            <div class="status-card">
                <h2>Estado de Carga</h2>
                <div class="value" id="chargingStatus">INACTIVO</div>
            </div>

            <div class="info-grid">
                <div class="info-box">
                    <label>Usuario</label>
                    <div class="value" id="userDisplay">-</div>
                </div>
                <div class="info-box">
                    <label>Balance</label>
                    <div class="value" id="balance">‚Ç¨0.00</div>
                </div>
                <div class="info-box">
                    <label>Energ√≠a Cargada</label>
                    <div class="value" id="energy">0.0 kWh</div>
                </div>
                <div class="info-box">
                    <label>Costo Actual</label>
                    <div class="value" id="cost">‚Ç¨0.00</div>
                </div>
            </div>

            <div class="info-box">
                <label>Punto de Carga</label>
                <div class="value" id="chargingPoint">-</div>
            </div>

            <!-- Progress Bar -->
            <div id="progressSection" class="hidden" style="margin-top: 20px;">
                <label style="color: #666; margin-bottom: 10px; display: block;">Progreso de Carga</label>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn btn-success" id="startBtn" onclick="requestCharging()">Solicitar Carga</button>
                <button class="btn btn-danger hidden" id="stopBtn" onclick="stopCharging()">Detener Carga</button>
                <button class="btn btn-primary" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <!-- Batch from file -->
            <div class="info-box" style="margin-top: 20px;">
                <label>Procesar archivo de servicios (uno por l√≠nea: CP_001, CP_002, ...)</label>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="file" id="servicesFile" accept=".txt" />
                    <div>
                        <label style="font-size: 12px; color:#666;">Duraci√≥n por CP (s)</label>
                        <input type="number" id="batchDuration" value="2" min="0" style="width:80px; padding:6px;">
                    </div>
                    <button class="btn btn-primary" onclick="processServicesFile()">Procesar archivo</button>
                </div>
                <small style="color:#666; display:block; margin-top:8px;">El Driver iniciar√° y detendr√° cada carga secuencialmente para automatizar las pruebas.</small>
            </div>

            <!-- Event Log -->
            <div class="event-log">
                <h3>Registro de Eventos</h3>
                <div id="eventLog"></div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentUser = null;
        let currentUserRole = null;
        let sessionData = {
            charging: false,
            energy: 0,
            cost: 0,
            cp_id: null
        };

        // Connect to WebSocket server
        function connectWebSocket() {
            // Usar hostname actual (funciona tanto en local como desde otros PCs)
            const hostname = window.location.hostname;
            const wsUrl = `ws://${hostname}:8001/ws`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                // Retry connection after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            const dot = statusDiv.querySelector('.status-dot');
            const text = statusDiv.querySelector('span:last-child');

            if (connected) {
                statusDiv.className = 'connection-status connected';
                dot.className = 'status-dot green';
                text.textContent = 'Conectado al servidor';
            } else {
                statusDiv.className = 'connection-status disconnected';
                dot.className = 'status-dot red';
                text.textContent = 'Desconectado del servidor';
            }
        }

        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            ws.send(JSON.stringify({
                type: 'login',
                username: username,
                password: password
            }));
        }

        function logout() {
            currentUser = null;
            sessionData = {
                charging: false,
                energy: 0,
                cost: 0,
                cp_id: null
            };
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            addEvent('Sesi√≥n cerrada');
        }

        function requestCharging() {
            // Deshabilitar el bot√≥n para evitar m√∫ltiples clicks
            const btn = document.getElementById('startBtn');
            if (btn.disabled) return;
            
            btn.disabled = true;
            btn.textContent = 'Procesando...';
            
            ws.send(JSON.stringify({
                type: 'request_charging',
                username: currentUser
            }));
            
            // Re-habilitar despu√©s de 5 segundos como failsafe
            setTimeout(() => {
                if (btn.disabled) {
                    btn.disabled = false;
                    btn.textContent = 'Solicitar Carga';
                }
            }, 5000);
        }

        function stopCharging() {
            ws.send(JSON.stringify({
                type: 'stop_charging',
                username: currentUser
            }));
        }

        function cpIdFromLine(line) {
            const t = (line || '').trim();
            if (!t) return null;
            // Si contiene espacios, coger el √∫ltimo token tipo CP_XXX
            const parts = t.split(/\s+/);
            for (let i = parts.length - 1; i >= 0; i--) {
                if (/^CP_\w+$/i.test(parts[i])) return parts[i];
            }
            // Si la l√≠nea ya es CP_XXX
            if (/^CP_\w+$/i.test(t)) return t;
            return null;
        }

        function processServicesFile() {
            console.log('[BATCH] processServicesFile called');
            if (!currentUser) { 
                console.log('[BATCH] ERROR: No currentUser');
                alert('Inicia sesi√≥n primero'); 
                return; 
            }
            console.log('[BATCH] Current user:', currentUser);
            
            const input = document.getElementById('servicesFile');
            if (!input.files || !input.files[0]) { 
                console.log('[BATCH] ERROR: No file selected');
                alert('Selecciona un archivo .txt'); 
                return; 
            }
            console.log('[BATCH] File selected:', input.files[0].name);
            
            const duration = parseInt(document.getElementById('batchDuration').value || '2', 10);
            console.log('[BATCH] Duration:', duration);
            
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = () => {
                console.log('[BATCH] File read complete');
                const lines = String(reader.result).split(/\r?\n/);
                console.log('[BATCH] Lines:', lines);
                
                const cpIds = lines.map(cpIdFromLine).filter(Boolean);
                console.log('[BATCH] Parsed CP IDs:', cpIds);
                
                if (cpIds.length === 0) { 
                    console.log('[BATCH] ERROR: No valid CP IDs found');
                    alert('El archivo no contiene CP IDs v√°lidos'); 
                    return; 
                }
                
                addEvent(`Procesando archivo: ${cpIds.length} servicios`);
                
                const message = {
                    type: 'batch_charging',
                    username: currentUser,
                    cp_ids: cpIds,
                    duration_sec: duration
                };
                console.log('[BATCH] Sending message:', message);
                console.log('[BATCH] WebSocket state:', ws.readyState, '(1=OPEN)');
                
                ws.send(JSON.stringify(message));
                console.log('[BATCH] Message sent');
            };
            reader.onerror = (e) => {
                console.error('[BATCH] ERROR reading file:', e);
                alert('Error al leer el archivo');
            };
            reader.readAsText(file, 'utf-8');
        }

        function handleServerMessage(data) {
            console.log('Received:', data);

            switch(data.type) {
                case 'login_response':
                    if (data.success) {
                        currentUser = data.user.username;
                        currentUserRole = data.user.role;
                        document.getElementById('loginSection').classList.add('hidden');
                        document.getElementById('dashboardSection').classList.remove('hidden');
                        document.getElementById('userDisplay').textContent = data.user.username;
                        document.getElementById('balance').textContent = `‚Ç¨${data.user.balance.toFixed(2)}`;
                        addEvent(`Bienvenido ${data.user.username}`);
                        
                        // Si tiene sesi√≥n activa, restaurar el estado
                        if (data.active_session) {
                            sessionData.charging = true;
                            sessionData.cp_id = data.active_session.cp_id;
                            document.getElementById('chargingStatus').textContent = 'CARGANDO';
                            document.getElementById('chargingPoint').textContent = data.active_session.cp_id;
                            document.getElementById('startBtn').classList.add('hidden');
                            document.getElementById('stopBtn').classList.remove('hidden');
                            document.getElementById('progressSection').classList.remove('hidden');
                            addEvent(`Sesion activa restaurada en ${data.active_session.cp_id}`);
                        }
                    } else {
                        alert('Login failed: ' + data.message);
                    }
                    break;

                case 'charging_pending':
                    document.getElementById('chargingStatus').textContent = 'ESPERANDO AUTORIZACI√ìN...';
                    addEvent((data.message || 'Esperando autorizaci√≥n...'));
                    break;
                
                case 'charging_started':
                    // FILTRAR: Solo procesar si es para el usuario actual
                    if (data.username && data.username !== currentUser) {
                        console.log(`[WS] Ignorando charging_started de otro usuario: ${data.username}`);
                        break;
                    }
                    
                    sessionData.charging = true;
                    sessionData.cp_id = data.cp_id;
                    document.getElementById('chargingStatus').textContent = 'CARGANDO';
                    document.getElementById('chargingPoint').textContent = data.cp_id;
                    
                    // Ocultar bot√≥n de inicio y mostrar de detenci√≥n
                    const startBtn = document.getElementById('startBtn');
                    startBtn.classList.add('hidden');
                    startBtn.disabled = false;
                    startBtn.textContent = 'Solicitar Carga';
                    
                    document.getElementById('stopBtn').classList.remove('hidden');
                    document.getElementById('progressSection').classList.remove('hidden');
                    addEvent(`Carga iniciada en ${data.cp_id}`);
                    break;

                case 'charging_update':
                    // Solo procesar actualizaciones del usuario actual
                    if (data.username === currentUser) {
                        sessionData.energy = data.energy;
                        sessionData.cost = data.cost;
                        document.getElementById('energy').textContent = `${data.energy.toFixed(2)} kWh`;
                        document.getElementById('cost').textContent = `‚Ç¨${data.cost.toFixed(2)}`;
                        
                        // Update progress bar (assuming 50 kWh = 100%)
                        const progress = Math.min((data.energy / 50) * 100, 100);
                        const progressBar = document.getElementById('progressBar');
                        progressBar.style.width = progress + '%';
                        progressBar.textContent = Math.round(progress) + '%';
                    }
                    break;

                case 'charging_stopped':
                    // FILTRAR: Solo procesar si es para el usuario actual
                    if (data.username && data.username !== currentUser) {
                        console.log(`[WS] Ignorando charging_stopped de otro usuario: ${data.username}`);
                        break;
                    }
                    
                    sessionData.charging = false;
                    document.getElementById('chargingStatus').textContent = 'COMPLETADO';
                    document.getElementById('startBtn').classList.remove('hidden');
                    document.getElementById('stopBtn').classList.add('hidden');
                    document.getElementById('balance').textContent = `‚Ç¨${data.new_balance.toFixed(2)}`;
                    addEvent(`Carga completada. Total: ‚Ç¨${data.total_cost.toFixed(2)}`);
                    setTimeout(() => {
                        document.getElementById('chargingStatus').textContent = 'INACTIVO';
                        document.getElementById('progressSection').classList.add('hidden');
                    }, 3000);
                    break;
                
                case 'error_simulated':
                    addEvent(`Error simulado en ${data.cp_id}: ${data.error_type}`);
                    refreshCPs();
                    break;
                
                case 'error_fixed':
                    addEvent(`Error corregido en ${data.cp_id}`);
                    refreshCPs();
                    break;
                
                    // EVENTOS DE ERROR DE CP DESDE CENTRAL
                case 'cp_error':
                    // Si el usuario est√° cargando en este CP, mostrar error
                    if (sessionData.cp_id === data.cp_id) {
                        document.getElementById('chargingStatus').textContent = 'ERROR EN CP';
                        addEvent(`${data.message}`);
                        alert(`Error en tu punto de carga: ${data.message}\nLa carga debe detenerse.`);
                        
                        // Mostrar bot√≥n de inicio, ocultar bot√≥n de detener
                        document.getElementById('startBtn').classList.remove('hidden');
                        document.getElementById('stopBtn').classList.add('hidden');
                        
                        // Limpiar sesi√≥n local
                        sessionData.charging = false;
                        sessionData.cp_id = null;
                    } else if (data.username && data.username === currentUser) {
                        // Si el error es para este usuario pero no est√° cargando
                        addEvent(`${data.message}`);
                    }
                    break;
                
                case 'cp_fixed':
                    addEvent(`${data.message}`);
                    break;
                
                case 'all_cps_status':
                    updateCPList(data.charging_points);
                    break;

                case 'batch_started':
                    addEvent(`Lote iniciado: ${data.total} elementos`);
                    break;

                case 'batch_progress':
                    if (data.status === 'started') {
                        addEvent(`[${data.index}] Inicio en ${data.cp_id} (sesi√≥n ${data.session_id})`);
                    } else if (data.status === 'stopped') {
                        addEvent(`[${data.index}] Fin en ${data.cp_id} | ${Number(data.energy||0).toFixed(2)} kWh | ‚Ç¨${Number(data.total_cost||0).toFixed(2)}`);
                    } else if (data.status === 'skipped') {
                        addEvent(`[${data.index}] Omitido ${data.cp_id}: ${data.reason}`);
                    }
                    break;

                case 'batch_complete':
                    addEvent('Lote completado');
                    break;

                case 'charging_ticket':
                    // üé´ RECIBIR TICKET FINAL DE CARGA
                    // FILTRAR: Solo procesar si es para el usuario actual
                    if (data.username && data.username !== currentUser) {
                        console.log(`[WS] Ignorando charging_ticket de otro usuario: ${data.username}`);
                        break;
                    }
                    
                    // Mostrar ticket en un alert o modal
                    const durationSec = data.duration_sec || 0;
                    const durationMin = Math.floor(durationSec / 60);
                    const durationSecRem = durationSec % 60;
                    const durationStr = durationMin > 0 
                        ? `${durationMin} min ${durationSecRem} s`
                        : `${durationSecRem} s`;
                    
                    const ticketMessage = `TICKET DE CARGA\n\n` +
                        `Punto de Carga: ${data.cp_id}\n` +
                        `Energ√≠a: ${Number(data.energy_kwh || 0).toFixed(2)} kWh\n` +
                        `Duraci√≥n: ${durationStr}\n` +
                        `Costo Total: ‚Ç¨${Number(data.cost || 0).toFixed(2)}\n` +
                        `Motivo: ${data.reason === 'manual_stop' ? 'Parada manual' : data.reason === 'completed' ? 'Desenchufe' : data.reason || 'Finalizada'}`;
                    
                    alert(ticketMessage);
                    
                    // Actualizar balance si viene en el ticket
                    if (data.new_balance !== undefined) {
                        document.getElementById('balance').textContent = `‚Ç¨${Number(data.new_balance).toFixed(2)}`;
                    }
                    
                    // Mostrar ticket en el registro de eventos
                    addEvent(`Ticket: ${Number(data.energy_kwh || 0).toFixed(2)} kWh - ‚Ç¨${Number(data.cost || 0).toFixed(2)}`);
                    
                    // Limpiar estado de carga
                    sessionData.charging = false;
                    sessionData.cp_id = null;
                    document.getElementById('chargingStatus').textContent = 'COMPLETADO';
                    document.getElementById('startBtn').classList.remove('hidden');
                    document.getElementById('stopBtn').classList.add('hidden');
                    document.getElementById('progressSection').classList.add('hidden');
                    
                    setTimeout(() => {
                        document.getElementById('chargingStatus').textContent = 'INACTIVO';
                    }, 3000);
                    break;

                case 'error':
                    alert('Error: ' + data.message);
                    addEvent('ERROR: ' + data.message);
                    
                    // Re-habilitar bot√≥n de inicio si est√° deshabilitado
                    const startBtn2 = document.getElementById('startBtn');
                    if (startBtn2.disabled) {
                        startBtn2.disabled = false;
                        startBtn2.textContent = 'Solicitar Carga';
                    }
                    break;
            }
        }

        function updateBalance(newBalance) {
            if (currentUser) {
                const balanceElement = document.getElementById('balance');
                balanceElement.textContent = `${newBalance.toFixed(2)}‚Ç¨`;
            }
        }

        function addEvent(message) {
            const logDiv = document.getElementById('eventLog');
            const now = new Date().toLocaleTimeString();
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.innerHTML = `<span class="timestamp">${now}</span> - ${message}`;
            logDiv.insertBefore(eventItem, logDiv.firstChild);

            // Keep only last 10 events
            while (logDiv.children.length > 10) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        // Initialize
        connectWebSocket();
    </script>
</body>
</html>
