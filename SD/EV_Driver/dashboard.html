<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó EV Driver Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-card h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .status-card .value {
            font-size: 3em;
            font-weight: bold;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .info-box label {
            display: block;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-box .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.green {
            background: #28a745;
        }

        .status-dot.red {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
        }

        .login-form input {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .hidden {
            display: none;
        }

        .event-log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .event-log h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .event-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 5px;
            font-size: 0.9em;
            border-left: 3px solid #667eea;
        }

        .event-item .timestamp {
            color: #999;
            font-size: 0.85em;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó EV Driver Dashboard</h1>
        <p class="subtitle">Sistema de Carga de Veh√≠culos El√©ctricos</p>

        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status disconnected">
            <span class="status-dot red"></span>
            <span>Desconectado del servidor</span>
        </div>

        <!-- Login Form -->
        <div id="loginSection">
            <form class="login-form" onsubmit="login(event)">
                <input type="text" id="username" placeholder="Usuario (ej: driver1)" required>
                <input type="password" id="password" placeholder="Contrase√±a (ej: pass123)" required>
                <button type="submit" class="btn btn-primary">Iniciar Sesi√≥n</button>
            </form>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardSection" class="hidden">
            <div class="status-card">
                <h2>Estado de Carga</h2>
                <div class="value" id="chargingStatus">INACTIVO</div>
            </div>

            <div class="info-grid">
                <div class="info-box">
                    <label>üë§ Usuario</label>
                    <div class="value" id="userDisplay">-</div>
                </div>
                <div class="info-box">
                    <label>üí∞ Balance</label>
                    <div class="value" id="balance">‚Ç¨0.00</div>
                </div>
                <div class="info-box">
                    <label>‚ö° Energ√≠a Cargada</label>
                    <div class="value" id="energy">0.0 kWh</div>
                </div>
                <div class="info-box">
                    <label>üíµ Costo Actual</label>
                    <div class="value" id="cost">‚Ç¨0.00</div>
                </div>
            </div>

            <div class="info-box">
                <label>üìç Punto de Carga</label>
                <div class="value" id="chargingPoint">-</div>
            </div>

            <!-- Progress Bar -->
            <div id="progressSection" class="hidden" style="margin-top: 20px;">
                <label style="color: #666; margin-bottom: 10px; display: block;">Progreso de Carga</label>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn btn-success" id="startBtn" onclick="requestCharging()">Solicitar Carga</button>
                <button class="btn btn-danger hidden" id="stopBtn" onclick="stopCharging()">Detener Carga</button>
                <button class="btn btn-primary" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <!-- Event Log -->
            <div class="event-log">
                <h3>üìã Registro de Eventos</h3>
                <div id="eventLog"></div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentUser = null;
        let sessionData = {
            charging: false,
            energy: 0,
            cost: 0,
            cp_id: null
        };

        // Connect to WebSocket server
        function connectWebSocket() {
            const wsUrl = 'ws://localhost:8001/ws';
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateConnectionStatus(true);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateConnectionStatus(false);
                // Retry connection after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            const dot = statusDiv.querySelector('.status-dot');
            const text = statusDiv.querySelector('span:last-child');

            if (connected) {
                statusDiv.className = 'connection-status connected';
                dot.className = 'status-dot green';
                text.textContent = 'Conectado al servidor';
            } else {
                statusDiv.className = 'connection-status disconnected';
                dot.className = 'status-dot red';
                text.textContent = 'Desconectado del servidor';
            }
        }

        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            ws.send(JSON.stringify({
                type: 'login',
                username: username,
                password: password
            }));
        }

        function logout() {
            currentUser = null;
            sessionData = {
                charging: false,
                energy: 0,
                cost: 0,
                cp_id: null
            };
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            addEvent('Sesi√≥n cerrada');
        }

        function requestCharging() {
            ws.send(JSON.stringify({
                type: 'request_charging',
                username: currentUser
            }));
        }

        function stopCharging() {
            ws.send(JSON.stringify({
                type: 'stop_charging',
                username: currentUser
            }));
        }

        function handleServerMessage(data) {
            console.log('Received:', data);

            switch(data.type) {
                case 'login_response':
                    if (data.success) {
                        currentUser = data.user.username;
                        document.getElementById('loginSection').classList.add('hidden');
                        document.getElementById('dashboardSection').classList.remove('hidden');
                        document.getElementById('userDisplay').textContent = data.user.username;
                        document.getElementById('balance').textContent = `‚Ç¨${data.user.balance.toFixed(2)}`;
                        addEvent(`Bienvenido ${data.user.username}`);
                    } else {
                        alert('Login failed: ' + data.message);
                    }
                    break;

                case 'charging_started':
                    sessionData.charging = true;
                    sessionData.cp_id = data.cp_id;
                    document.getElementById('chargingStatus').textContent = 'CARGANDO ‚ö°';
                    document.getElementById('chargingPoint').textContent = data.cp_id;
                    document.getElementById('startBtn').classList.add('hidden');
                    document.getElementById('stopBtn').classList.remove('hidden');
                    document.getElementById('progressSection').classList.remove('hidden');
                    addEvent(`Carga iniciada en ${data.cp_id}`);
                    break;

                case 'charging_update':
                    sessionData.energy = data.energy;
                    sessionData.cost = data.cost;
                    document.getElementById('energy').textContent = `${data.energy.toFixed(2)} kWh`;
                    document.getElementById('cost').textContent = `‚Ç¨${data.cost.toFixed(2)}`;
                    
                    // Update progress bar (assuming 50 kWh = 100%)
                    const progress = Math.min((data.energy / 50) * 100, 100);
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = Math.round(progress) + '%';
                    break;

                case 'charging_stopped':
                    sessionData.charging = false;
                    document.getElementById('chargingStatus').textContent = 'COMPLETADO ‚úì';
                    document.getElementById('startBtn').classList.remove('hidden');
                    document.getElementById('stopBtn').classList.add('hidden');
                    document.getElementById('balance').textContent = `‚Ç¨${data.new_balance.toFixed(2)}`;
                    addEvent(`Carga completada. Total: ‚Ç¨${data.total_cost.toFixed(2)}`);
                    setTimeout(() => {
                        document.getElementById('chargingStatus').textContent = 'INACTIVO';
                        document.getElementById('progressSection').classList.add('hidden');
                    }, 3000);
                    break;

                case 'error':
                    alert('Error: ' + data.message);
                    addEvent('‚ùå ' + data.message);
                    break;
            }
        }

        function addEvent(message) {
            const logDiv = document.getElementById('eventLog');
            const now = new Date().toLocaleTimeString();
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.innerHTML = `<span class="timestamp">${now}</span> - ${message}`;
            logDiv.insertBefore(eventItem, logDiv.firstChild);

            // Keep only last 10 events
            while (logDiv.children.length > 10) {
                logDiv.removeChild(logDiv.lastChild);
            }
        }

        // Initialize
        connectWebSocket();
    </script>
</body>
</html>
